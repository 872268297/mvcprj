@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>编辑资料</title>
    <link href="~/lib/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
    <script src="~/lib/jquery/dist/jquery.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="~/js/vue.min.js"></script>
    <script src="~/js/ck/ckplayer/ckplayer.js"></script>
    <script src="~/js/layer/layer.js"></script>
    <script src="~/js/md5.js"></script>
    <link href="~/css/myStyle.css" rel="stylesheet" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" style="background-color:rgba(255, 255, 255, 0.95);z-index:1000;">
        <div class="container" id="div_header_container">
            <div class="navbar-header">
                <a class="navbar-brand " href="/"><span class="top_header_item">首页</span></a>
            </div>
            <div class="navbar-header">
                <a class="navbar-brand" href="/Directory/0"><span class="top_header_item">直播</span></a>
            </div>
            <div class="navbar-header">
                <a class="navbar-brand" href="/Class"><span class="top_header_item">分类</span></a>
            </div>
            <div class="navbar-header" style="padding-top:8px;padding-bottom:8px;box-sizing:border-box;height:50px;">
                <div class="header-search">
                    <input type="text" id="txt_search" placeholder="搜索" readonly onfocus="this.removeAttribute('readonly');" autocomplete="off" />
                    <div class="header-search-btn">
                        <img style="width:20px;height:20px;" src="../fonts/Search_24.14055636896px_1181298_easyicon.net.png" />
                    </div>
                </div>
            </div>
            <div id="right_top_float" style="float:right;">
                <div id="div_login_panel" style="display:inline-block">
                    <a href="javascript:;" class="a_rightTop" id="a_login" style="" onclick="ShowLoginDlg()">登录</a>
                    <span id="_shuxian" style="font-size: 16px;line-height: 50px;">|</span>
                    <a href="javascript:;" class="a_rightTop" id="a_reg" onclick="ShowRegDlg()">注册</a>
                </div>
                <div id="div_login_ed_panel" style="display:inline-block;display:none;">
                    <img id="head_right_top" style="width:36px;height:36px;border-radius:18px;margin-right:2px;cursor:pointer;" onclick="location.href='/Personal'" src="@ViewBag.UserAsset.HeadIcon" />
                    <a href="/Personal" class="a_rightTop" id="a_user"></a>
                    <span id="_shuxian2" style="font-size: 16px;line-height: 50px;">|</span>
                    <a href="javascript:;" class="a_rightTop" id="a_logout">注销</a>
                </div>
            </div>
        </div>
    </nav>


    <div class="container" style="margin-top:66px;">
        <div class="main_div" style="width:80%;margin:0 auto 0 auto; background-color:rgba(255, 255, 255, 0.95);min-height:890px;position:relative;">
            <div class="divLeftNav">
                <div class="left-nav-header">个人中心</div>
                <div class="left-nav-item ">
                    <a href="/Personal">
                        我的信息
                    </a>
                </div>
                <div class="left-nav-item active">
                    <a href="/Personal/EditInfo">
                        编辑资料
                    </a>
                </div>
            </div>
            <div style="margin-left:180px;position:relative;">

                <div class="main_content">
                    <div style="font-size:24px;height:70px;">
                        <div class="btn_back" onclick="window.location.href = '/Personal';">＜</div>
                        编辑资料
                    </div>

                    <div style="vertical-align:top;">
                        <span style="text-align:right;width:100px;display:inline-block;color:#777;vertical-align: top;">
                            昵称
                        </span>
                        <span style="display:inline-block;margin-left:20px;color:#777;">
                            @ViewBag.User
                        </span>
                    </div>

                    <div style="vertical-align:top;margin-top:15px;">
                        <span style="text-align:right;width:100px;display:inline-block;color:#777;vertical-align: top;">
                            个性签名
                        </span>
                        <textarea id="sign" style="resize: none;border-color:#ccc;display:inline-block;margin-left:20px;" maxlength="64" rows="4" cols="36">@ViewBag.UserAsset.Sign</textarea>
                    </div>
                    <div style="vertical-align:top;margin-top:15px;">
                        <span id="sex" style="text-align:right;width:100px;display:inline-block;color:#777;vertical-align: top;">
                            性别
                        </span>
                        <div style="display:inline-block;margin-left:20px;">
                            <input type="radio" name="sex" value="男" @Html.Raw(ViewBag.UserAsset.Sex == "男" ? "checked" : "") />男
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <input type="radio" name="sex" value="女" @Html.Raw(ViewBag.UserAsset.Sex == "男" ? "" : "checked") />女
                        </div>
                    </div>
                    <div style="vertical-align:top;margin-top:15px;">
                        <span style="text-align:right;width:100px;display:inline-block;color:#777;vertical-align:middle;">
                            年龄
                        </span>
                        <div style="display:inline-block;margin-left:20px;">
                            <select id="age" class="form-control">
                                @{
                                    int age = ViewBag.UserAsset.Age;
                                }
                                @for (int i = 0; i < 120; i++)
                                {
                                    if (age == i)
                                    {
                                        <option selected="selected">@i</option>
                                    }
                                    else
                                    {
                                        <option>@i</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div style="vertical-align:top;margin-top:15px;">
                        <span style="text-align:right;width:100px;display:inline-block;color:#777;vertical-align:middle;">
                            &nbsp;
                        </span>
                        <div class="btn-save" style="margin-left:20px;">
                            保存
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="display:none;" id="divLoginAndReg">
        <div style="text-align:center;display:none;width:92%;margin:10px auto 0 auto;" id="divReg">
            <div class="form-horizontal  ">
                <div class="form-group">
                    <span class="col-sm-3 control-label">用户名</span>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="txtRegUser" />
                    </div>
                </div>
                <div class="form-group">
                    <span class="col-sm-3 control-label">密码</span>
                    <div class="col-sm-9">
                        <input type="password" class="form-control" id="txtRegPass" />
                    </div>
                </div>
                <div class="form-group">
                    <span class="col-sm-3 control-label">确认密码</span>
                    <div class="col-sm-9">
                        <input type="password" class="form-control" id="txtRegPass2" />
                    </div>
                </div>
            </div>

            <input class="btn btn-block  btn-info" type="button" id="btnReg" value="注册" />
        </div>

        <div style="text-align:center;width:92%;margin:10px auto 0 auto;" id="divLogin">
            <div class="form-horizontal ">
                <div class="form-group">
                    <span class="col-sm-3 control-label">用户名</span>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="txtLoginUser" />
                    </div>
                </div>
                <div class="form-group">
                    <span class="col-sm-3 control-label">密码</span>
                    <div class="col-sm-9">
                        <input type="password" class="form-control" id="txtLoginPass" />
                    </div>
                </div>
                <div class="form-group">
                    <span class="col-sm-3 control-label">
                        验证码
                    </span>
                    <div class="col-sm-5">
                        <input type="text" class="form-control" id="validCode" />
                    </div>
                    <div class="col-sm-4">
                        <img src="../api/User/VerificationCode?seed=123" id="imgCode" onclick="this.src+='1'" alt="验证码" title="点击换一个" />
                    </div>

                </div>
            </div>
            <input class="btn btn-block btn-info" type="button" id="btnLogin" value="登录" />
        </div>
    </div>
    <script type="text/javascript">

        var user = '@ViewBag.User';
        user = unescape(user.replace(/&#x/g, '%u').replace(/;/g, ''));

        var asset = '@ViewBag.UserAssetJson';

        if (asset != 'null') {
            asset = JSON.parse(asset.replace(/&quot;/gi, '"'));
        } else {
            asset = null;
        }

        function getStyle(obj, styleName) {
            if (obj.currentStyle) { return obj.currentStyle[styleName]; } else {
                return getComputedStyle(obj, null)[styleName];
            }
        }

        function randomNum(minNum, maxNum) {
            switch (arguments.length) {
                case 1:
                    return parseInt(Math.random() * minNum + 1, 10);
                    break;
                case 2:
                    return parseInt(Math.random() * (maxNum - minNum + 1) + minNum, 10);
                    break;
                default:
                    return 0;
                    break;
            }
        }

        $(function () {

            $('#btnReg').off('click').on('click', function () {
                var username = $('#txtRegUser').val();
                var password = $('#txtRegPass').val();
                var password2 = $('#txtRegPass2').val();
                if (username.length < 1 || password.length < 1) {
                    alert('用户名和密码长度不足');
                    return;
                }
                if (password != password2) {
                    alert('两次输入密码不一致');
                    return;
                }
                $.post('../api/User/Reg', { 'username': username, 'password': hex_md5(password) }, res => {
                    if (res.success) {
                        layer.closeAll();
                        Login(username, hex_md5(password),'15212310');//注册成功登录
                        layer.msg('注册成功');
                    } else {
                        alert(res.message);
                    }
                });
            });


            $('#btnLogin').off('click').on('click', function () {
                var username = $('#txtLoginUser').val();
                var password = $('#txtLoginPass').val();
                var code = $('#validCode').val();
                if (username == '' || password == ''||code=='') {
                    return;
                }
                Login(username, hex_md5(password),code);
            });


            $('.Aside-toggle-Expand').off('click').on('click', function (e) {
                $('.Aside-toggle-Expand,.left_expand').hide();
                $('.Aside-toggle-Shark,.left_shark').show();
                $('.left').css('width', '0');
                //resize();
            });

            $('.Aside-toggle-Shark').off('click').on('click', function (e) {
                $('.Aside-toggle-Expand,.left_expand').show();
                $('.Aside-toggle-Shark,.left_shark').hide();
                $('.left').css('width', '240px');
                //resize();
            });


            $('.header-search-btn ').click(function () {
                window.location.href = '/Search/' + $('#txt_search').val();
            });

            $('#txt_search').keyup(function (event) {
                if (event.keyCode == 13) {
                    window.location.href = '/Search/' + $('#txt_search').val();
                }
            });

            $('#img_head_icon,.btnUploadHead,.head_mask').click(function () {
                $('[name=file]').click();
            });
            $('[name=file]').on('change', function () {
                doUploadHead();
            });

            $('.btn-save').click(function () {
                $.post('/api/Personal/EditInfo', {
                    sign : $('#sign').val(),
                    sex: $('input[name=sex]:checked').val(),
                    age: $("#age option:selected").text()
                }, function (res) {
                    if (res.success) {
                        layer.msg('修改成功');
                        //window.location.href = '/Personal/EditInfo';
                    } else {
                        layer.msg(res.message);
                    }
                });
            });

            if (user != '') {
                ShowAfterLogin();
            }
            $('#right_top_float').show();
        });

        function doUploadHead() {
            var formData = new FormData($("#uploadForm")[0]);
            //console.log(formData);
            $.ajax({
                url: '../api/Personal/UploadHead',
                type: 'POST',
                data: formData,
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function (res) {
                    asset.HeadIcon = res.data;
                    $('#head_right_top').attr('src', res.data);
                    $('#img_head_icon').attr('src', res.data);
                    layer.msg('修改成功');
                },
                error: function (res) {
                    layer.msg(res.message);
                }
            });
        }

        function Login(username , pwd ,code) {
            $.post('../api/User/Login', {
                'username': username, 'password': pwd,
                'code': code
            }, function(res) {
                if (res.success) {
                    layer.closeAll();
                    $('#imgCode').click();
                    user = res.data[0].userName;
                    asset = res.data[1];
                    $('#head_right_top').attr('src', asset.headIcon);
                    ShowAfterLogin();
                } else {
                    layer.msg(res.message);
                    $('#imgCode').click();
                }
            });
        }

        function ShowAfterLogin() {
            $('#div_login_panel').hide();
            $('#a_user').text(user);
            $('#div_login_ed_panel').show();
            $("#a_logout").show().off('click').on('click', function () {
                $.post('../api/User/LogOut', {}, function (res) {
                    if (res.success) {
                        window.location.href = "/";
                        $('#div_login_panel').show();
                        $('#div_login_ed_panel').hide();
                        user = '';
                    } else {
                        layer.msg(res.message);
                    }
                });
            });
        }

        function ShowLoginDlg() {
            $('#txtLoginUser').val('');
            $('#txtLoginPass').val('');
            $('#validCode').val('');
            $('#divReg').hide();
            $('#divLogin').show();
            layer.open({
                type: 1,
                title: '登录',
                content: $('#divLoginAndReg'),
                area: ['420px', '260px'],
                cancel: function () {
                    $('#imgCode').click();
                }

            });
        }

        function ShowRegDlg() {
            $('#txtRegUser').val('');
            $('#txtRegPass').val('');
            $('#txtRegPass2').val('');
            $('#divReg').show();
            $('#divLogin').hide();
            layer.open({
                type: 1,
                title: '注册账号',
                content: $('#divLoginAndReg'),
                area: ['420px', '255px']

            });
        }

    </script>


</body>
</html>
